/*
 *	(c) 2015 László TÓTH
 *	(c) 2020 Stuart Hunter
 *
 *	TODO:
 *
 *	This program is free software: you can redistribute it and/or modify
 *	it under the terms of the GNU General Public License as published by
 *	the Free Software Foundation, either version 3 of the License, or
 *	(at your option) any later version.
 *
 *	This program is distributed in the hope that it will be useful,
 *	but WITHOUT ANY WARRANTY; without even the implied warranty of
 *	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *	GNU General Public License for more details.
 *
 *	See <http://www.gnu.org/licenses/> to get a copy of the GNU General
 *	Public License.
 *
 */

#include <errno.h>
#include <pthread.h>
#include <stdio.h>
#include <string.h>

#include <sys/types.h>
#include <unistd.h>
#include <stdint.h>

#include "display.h"
#include "oledimg.h"

#ifdef __arm__

// clang-format off
// retain this include order
#include "ArduiPi_OLED_lib.h"
#include "Adafruit_GFX.h"
#include "ArduiPi_OLED.h"
// clang-format on

#define SLEEP_TIME (25000 / 25)

ArduiPi_OLED display;
int sleep_divisor = 1;
int oledType = OLED_SH1106_I2C_128x64;

// http://javl.github.io/image2cpp/
const uint8_t splash[] = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x01, 0x1f, 0x80, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0xff, 0xe0, 0x1f, 0xfe, 0x01, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0xb0, 0xf0, 0x7f, 0xff, 0x93, 0xf7, 0x90, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x78, 0x7f, 0xff, 0x83, 0x81, 0xe0, 0x00, 0x06, 0x03, 0x03, 0x07, 0xc0, 0x00, 0x00, 
0x00, 0x00, 0x70, 0x7f, 0xff, 0x81, 0x80, 0x40, 0x00, 0x06, 0x03, 0x07, 0x0e, 0xe0, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x3f, 0xff, 0x00, 0x00, 0x00, 0x00, 0x06, 0x03, 0x87, 0x18, 0x60, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x3f, 0xff, 0x00, 0x00, 0x00, 0x00, 0x06, 0x03, 0x87, 0x18, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x17, 0xff, 0x00, 0x00, 0x00, 0x00, 0x06, 0x03, 0xcf, 0x1c, 0x00, 0x00, 0x00, 
0x00, 0x0c, 0x00, 0x2f, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x06, 0x03, 0x4b, 0x0f, 0x80, 0x00, 0x00, 
0x00, 0x1f, 0x00, 0x2f, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x06, 0x03, 0x7b, 0x03, 0xe0, 0x00, 0x00, 
0x00, 0x9f, 0x80, 0x0f, 0xfc, 0x00, 0x0e, 0x00, 0x00, 0x06, 0x03, 0x7b, 0x00, 0x60, 0x00, 0x00, 
0x00, 0xdf, 0x80, 0x1f, 0x7a, 0x00, 0x1f, 0x00, 0x00, 0x06, 0x03, 0x33, 0x00, 0x20, 0x00, 0x00, 
0x00, 0xff, 0xc0, 0x3e, 0xf7, 0x00, 0x3f, 0x90, 0x00, 0x06, 0x03, 0x33, 0x18, 0x60, 0x00, 0x00, 
0x00, 0x7f, 0xc0, 0x3d, 0xe7, 0x00, 0x7f, 0x60, 0x00, 0x07, 0xf3, 0x03, 0x1e, 0xe0, 0x00, 0x00, 
0x00, 0x7f, 0xc0, 0x33, 0xcf, 0x00, 0x7f, 0xe0, 0x00, 0x07, 0xf3, 0x03, 0x0f, 0x80, 0x00, 0x00, 
0x00, 0x3f, 0x80, 0x13, 0xce, 0x00, 0x7f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x7f, 0xf0, 0x17, 0x9e, 0x00, 0x7f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x7f, 0xf8, 0x07, 0x3e, 0x07, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0xff, 0xf0, 0x0f, 0x3e, 0x03, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0xff, 0xe0, 0x0e, 0x7e, 0x01, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x7f, 0xe0, 0x1e, 0x7e, 0x01, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x7f, 0xe0, 0x1c, 0xfe, 0x01, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0xff, 0xf2, 0x1c, 0xfc, 0x43, 0xff, 0x81, 0x81, 0x80, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x00, 
0x00, 0x7f, 0xf3, 0x1d, 0xfc, 0x67, 0xff, 0x01, 0x83, 0x80, 0x00, 0x00, 0xcc, 0x00, 0x00, 0x00, 
0x00, 0x3f, 0xf1, 0x19, 0xfc, 0x67, 0xff, 0xc1, 0xc3, 0x80, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 
0x00, 0x1f, 0xf0, 0x19, 0xfc, 0x07, 0xff, 0x01, 0xc3, 0x83, 0xc3, 0x70, 0xdf, 0x8f, 0x0d, 0xc0, 
0x00, 0x3f, 0xf8, 0x1b, 0xfc, 0x07, 0xfe, 0x01, 0xe7, 0x86, 0x63, 0x88, 0xcc, 0x19, 0x8e, 0x00, 
0x00, 0x1f, 0xfe, 0x17, 0xf8, 0x3f, 0xfc, 0x01, 0xa5, 0x8c, 0x33, 0x0c, 0xcc, 0x30, 0xcc, 0x00, 
0x00, 0x0f, 0xfc, 0x37, 0xfc, 0x7f, 0xfe, 0x01, 0xbd, 0x8c, 0x33, 0x0c, 0xcc, 0x30, 0xcc, 0x00, 
0x00, 0x0f, 0xfd, 0x77, 0xfc, 0x7f, 0xf8, 0x01, 0xb9, 0x88, 0x33, 0x0c, 0xcc, 0x20, 0xcc, 0x00, 
0x00, 0x07, 0xfd, 0x7f, 0xfe, 0x7f, 0xf8, 0x01, 0x99, 0x8c, 0x33, 0x0c, 0xcc, 0x30, 0xcc, 0x00, 
0x00, 0x01, 0xff, 0x7f, 0xfe, 0xff, 0xf0, 0x01, 0x99, 0x8c, 0x33, 0x0c, 0xc4, 0x30, 0xcc, 0x00, 
0x00, 0x00, 0x3f, 0x7f, 0xfe, 0x7e, 0xc0, 0x01, 0x81, 0x86, 0x63, 0x0c, 0xc4, 0x19, 0x8c, 0x00, 
0x00, 0x00, 0x1b, 0x7e, 0x7e, 0xfc, 0x00, 0x01, 0x81, 0x83, 0xc3, 0x0c, 0xc7, 0x8f, 0x0c, 0x00, 
0x00, 0x00, 0x1e, 0xe7, 0xc7, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x0d, 0xc0, 0x03, 0xb0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x0b, 0xc0, 0x03, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x03, 0xc8, 0x33, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x03, 0xe0, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x03, 0xf0, 0x0f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x03, 0xf8, 0x1f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0xfc, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x07, 0x83, 0xe0, 0x78, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x3f, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x67, 0x0c, 0xc6, 0x70, 0xcc, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x39, 0xbc, 0x00, 0x00, 0x00, 0x00, 0x01, 0x08, 0x60, 0x10, 0x86, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x11, 0x18, 0x00, 0x00, 0x00, 0x00, 0x01, 0x18, 0x60, 0x11, 0x86, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x18, 0x60, 0x11, 0x86, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x18, 0x20, 0x31, 0x82, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x01, 0x10, 0x00, 0x00, 0x00, 0x00, 0x06, 0x18, 0x20, 0x61, 0x82, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x0d, 0x70, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x18, 0x60, 0xc1, 0x86, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x61, 0x81, 0x86, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x08, 0x63, 0x00, 0x86, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0x0c, 0xc7, 0x00, 0xcc, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x87, 0x87, 0xf8, 0x78, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x03, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x02, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

#endif

int maxCharacter(void) { return 21; } // review when we get scroll working

int maxLine(void) { return 8; }

int maxXPixel(void) { return 128; }

int maxYPixel(void) { return 64; }

#ifdef __arm__

#define BIGCHAR_LEN 144

void bigChar(uint8_t cc, int x) {
  
  // need fix for space, and minus sign
  int start = (cc-48)*BIGCHAR_LEN;
  uint8_t dest[BIGCHAR_LEN];
  memcpy(dest, lcd23x48+start, sizeof dest);
  display.drawBitmap(x, 1, dest, 23, 48, WHITE);

}

void resetDisplay(int fontSize) {
  display.clearDisplay(); // clears the screen  buffer
  display.setTextSize(fontSize);
  display.setTextColor(WHITE);
  display.display(); // display it (clear display)
}

int initDisplay(void) {
  if (!display.init(OLED_I2C_RESET, oledType)) {
    return EXIT_FAILURE;
  }

  display.begin();
  resetDisplay(1);
  return 0;

}

void closeDisplay(void) {
  display.clearDisplay();

  // Free PI GPIO ports
  display.close();

  return;
}

void splashScreen(void) {
  display.clearDisplay();
  display.drawBitmap(0, 0, splash, 128, 64, WHITE);
  display.display();
  delay(5000);
  display.clearDisplay();
  display.display();
}

void drawTimeBlink(uint8_t cc) {
  int x = 2+(2*25);
  if (32 == cc)
    display.fillRect(58, 0, 10, display.height()-16, BLACK);
  else
    bigChar(cc, x);
  display.display();
}

void drawTimeText(char *buff) {

  display.fillRect(0, 0, display.width(), display.height()-16, BLACK);
  // digit walk and "blit"
  int x = 2;
  for (size_t i = 0; i < strlen(buff); i++){
    bigChar(buff[i], x);
    x += 25;
  }
}

void drawHorizontalBargraph(int x, int y, int w, int h, int percent) {

  if (x == -1) {
    x = 0;
    w = display.width() - 2; // is a box so -2 for sides!!!
  }

  if (y == -1) {
    y = display.height() - h;
  }

  display.fillRect(x, y, (int16_t)w, h, 0);
  display.drawHorizontalBargraph(x, y, (int16_t)w, h, 1, (uint16_t)percent);

  return;
}

void refreshDisplay(void) { display.display(); }

void putText(int x, int y, char *buff) {
  display.setTextSize(1);
  display.fillRect(x, y, (int16_t)strlen(buff) * CHAR_WIDTH, CHAR_HEIGHT, 0);
  display.setCursor(x, y);
  display.print(buff);
}

void clearLine(int y) { display.fillRect(0, y, maxXPixel(), CHAR_HEIGHT, 0); }

void putTextToCenter(int y, char *buff) {
  int tlen = strlen(buff);
  int px = maxCharacter() < tlen ? 0 : (maxXPixel() - (tlen * CHAR_WIDTH)) / 2;
  clearLine(y);
  putText(px, y, buff);
}

// need scroller - independant threaded

/*

char message[] = "The quick Brown fox jumped Over the Lazy Dog";
int x, minX;

x = display.width();
minX = -CHAR_WIDTH * 2 * strlen(message); 

...

display.setCursor(x,line);
display.print(message);
if (x < minX)
  x = display.width();



*/

#endif
